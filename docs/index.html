<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Gul Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  
  <style>
    /* === –°–¢–ò–õ–ò (–±—ã–≤—à–∏–π style.css) === */
    body { 
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
        margin: 0; 
        background: #0f0f12; 
        color: #fff; 
        -webkit-font-smoothing: antialiased;
    }
    .wrap { max-width: 720px; margin: 0 auto; padding: 16px; }
    
    .card { 
        background: #1b1b22; 
        padding: 16px; 
        border-radius: 14px; 
        margin: 12px 0; 
        box-shadow: 0 4px 12px rgba(0,0,0,0.2); 
    }
    
    .hidden { display: none !important; }
    
    h1, h2, h3 { margin-top: 0; font-weight: 700; }
    h1 { color: #2a5fff; }
    
    label { display: block; margin-top: 12px; color: #aaa; font-size: 14px; margin-bottom: 4px; }

    input, select { 
        width: 100%; 
        padding: 14px; 
        box-sizing: border-box; 
        border-radius: 12px; 
        border: 1px solid #333; 
        background: #111; 
        color: #fff; 
        font-size: 16px; /* –í–∞–∂–Ω–æ –¥–ª—è iOS, —á—Ç–æ–±—ã –Ω–µ –ø—Ä–∏–±–ª–∏–∂–∞–ª–æ —ç–∫—Ä–∞–Ω */
        outline: none;
        transition: border-color 0.2s;
    }
    
    input:focus, select:focus { border-color: #2a5fff; }
    
    button { 
        width: 100%;
        padding: 14px; 
        border-radius: 12px; 
        border: 0; 
        background: #2a5fff; 
        color: #fff; 
        cursor: pointer; 
        font-weight: 600;
        font-size: 15px;
        transition: opacity 0.2s, transform 0.1s;
        margin-top: 10px;
    }
    button:active { opacity: 0.8; transform: scale(0.98); }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    
    .secondary-btn { background: #333; }
    
    .row { display: flex; gap: 10px; margin-top: 12px; }
    
    pre { 
        white-space: pre-wrap; 
        background: #000; 
        padding: 12px; 
        border-radius: 8px; 
        font-size: 12px; 
        color: #4f4; 
        border: 1px solid #333;
    }
    
    .order-item {
        background: #25252e;
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 8px;
        border-left: 4px solid #2a5fff;
    }

    /* –ë–ª–æ–∫ –æ—à–∏–±–æ–∫ */
    #error-log { color: #ffadad; background: #3a1111; padding: 10px; border-radius: 8px; margin-bottom: 10px; font-family: monospace; font-size: 11px; word-break: break-all; }
  </style>
</head>
<body>
  <div class="wrap">
    
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h1>Gul Delivery</h1>
        <div id="userInfo" style="font-size: 12px; color: #aaa; text-align: right;"></div>
    </div>

    <!-- –õ–æ–≥ –æ—à–∏–±–æ–∫ (—Å–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
    <div id="error-log" class="hidden"></div>

    <!-- –°—Ç–∞—Ç—É—Å –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div id="status" class="card" style="text-align: center; color: #888;">
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...
    </div>

    <!-- –≠–ö–†–ê–ù 1: –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø -->
    <div id="reg" class="card hidden">
      <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
      <p style="color: #ccc; font-size: 14px; margin-bottom: 20px;">
          –ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É, —É–∫–∞–∂–∏—Ç–µ –≤–∞—à—É —Ä–æ–ª—å –∏ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞.
      </p>
      
      <label>–í–∞—à–∞ —Ä–æ–ª—å</label>
      <select id="role">
          <option value="shop">–ú–∞–≥–∞–∑–∏–Ω (–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å)</option>
          <option value="courier">–ö—É—Ä—å–µ—Ä (–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å)</option>
      </select>

      <label>–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label>
      <input id="phone" type="tel" placeholder="+996 555 000 000" />
      
      <button id="btnContact" class="secondary-btn" style="margin-top: 5px; font-size: 12px; padding: 8px;">
        ‚ÑπÔ∏è –í–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é (WebApp –Ω–µ –æ—Ç–¥–∞—ë—Ç –Ω–æ–º–µ—Ä)
      </button>

      <div style="margin-top: 20px;">
        <button id="btnRegister">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
      </div>
    </div>

    <!-- –≠–ö–†–ê–ù 2: –°–ü–ò–°–û–ö –ó–ê–ö–ê–ó–û–í -->
    <div id="app" class="hidden">
      
      <div class="row">
        <button id="btnNew" class="hidden" style="background: #28a745;">+ –°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑</button>
        <button id="btnReload" class="secondary-btn" style="width: auto;">‚Üª</button>
      </div>
      
      <h3 style="margin-top: 20px;">–ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–∫–∞–∑—ã</h3>
      <div id="orders-container">
         <div style="text-align: center; color: #555; padding: 20px;">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞...</div>
      </div>
    </div>

    <!-- –≠–ö–†–ê–ù 3: –°–û–ó–î–ê–ù–ò–ï –ó–ê–ö–ê–ó–ê (–ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ) -->
    <div id="newOrder" class="card hidden" style="border: 1px solid #444;">
      <h3>–ù–æ–≤—ã–π –∑–∞–∫–∞–∑</h3>
      
      <label>–û—Ç–∫—É–¥–∞ –∑–∞–±—Ä–∞—Ç—å (–ê–¥—Ä–µ—Å/–ú–∞–≥–∞–∑–∏–Ω)</label>
      <input id="from_address" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –¶–£–ú, 1 —ç—Ç–∞–∂" />
      
      <label>–ö–æ–Ω—Ç–∞–∫—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è</label>
      <input id="shop_contact" placeholder="+996..." />
      
      <label>–ö—É–¥–∞ –¥–æ—Å—Ç–∞–≤–∏—Ç—å</label>
      <input id="to_address" placeholder="–£–ª–∏—Ü–∞, –¥–æ–º" />
      
      <label>–ö–≤ / –û—Ñ–∏—Å / –≠—Ç–∞–∂</label>
      <input id="to_apt" placeholder="–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ" />
      
      <label>–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞</label>
      <input id="client_name" placeholder="–ò–º—è" />
      
      <label>–¢–µ–ª–µ—Ñ–æ–Ω –∫–ª–∏–µ–Ω—Ç–∞</label>
      <input id="client_phone" type="tel" placeholder="+996..." />
      
      <label>–¶–µ–Ω–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ (—Å–æ–º)</label>
      <input id="price" type="number" placeholder="150" />
      
      <div class="row">
        <button id="btnCreate">–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑</button>
      </div>
      <div class="row">
        <button id="btnCancel" class="secondary-btn">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>

    <div style="margin-top: 40px; text-align: center; color: #333; font-size: 11px;">
       Gul Delivery v1.1
    </div>
  </div>

  <script>
    // === –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø (–±—ã–≤—à–∏–π config.js) ===
    window.BACKEND_URL = "https://gul-rtg0.onrender.com"; // –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–æ –≤–∞—à –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –∞–¥—Ä–µ—Å Render

    // === –õ–û–ì–ò–ö–ê (–±—ã–≤—à–∏–π app.js) ===
    const tg = window.Telegram?.WebApp;
    
    // –≠–ª–µ–º–µ–Ω—Ç—ã
    const statusEl = document.getElementById('status');
    const errorLogEl = document.getElementById('error-log');
    const userInfoEl = document.getElementById('userInfo');
    
    const regEl = document.getElementById('reg');
    const appEl = document.getElementById('app');
    const newOrderEl = document.getElementById('newOrder');
    const ordersContainer = document.getElementById('orders-container');
    
    const btnRegister = document.getElementById('btnRegister');
    const btnReload = document.getElementById('btnReload');
    const btnNew = document.getElementById('btnNew');
    const btnCreate = document.getElementById('btnCreate');
    const btnCancel = document.getElementById('btnCancel');

    // === –£–¢–ò–õ–ò–¢–´ ===

    function showError(msg) {
        console.error(msg);
        errorLogEl.classList.remove('hidden');
        errorLogEl.innerHTML = `<div>‚ö†Ô∏è ${msg}</div>` + errorLogEl.innerHTML;
        statusEl.textContent = "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞";
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è TG
    try {
        tg?.ready();
        tg?.expand();
        // –ö—Ä–∞—Å–∏–º —à–∞–ø–∫—É —Ç–µ–ª–µ–≥—Ä–∞–º–∞ –≤ —á–µ—Ä–Ω—ã–π
        if (tg) {
            tg.setHeaderColor('#0f0f12');
            tg.setBackgroundColor('#0f0f12');
        }
    } catch (e) { console.error(e); }

    function getAuthHeader() {
        const initData = tg?.initData || '';
        return { 'Authorization': 'tma ' + initData };
    }

    async function api(path, opts = {}) {
        const baseUrl = (window.BACKEND_URL || '').replace(/\/$/, '');
        const url = baseUrl + path;
        
        const headers = { 
            ...(opts.headers || {}), 
            ...getAuthHeader(), 
            'Content-Type': 'application/json' 
        };

        try {
            const res = await fetch(url, { ...opts, headers });
            const txt = await res.text();
            
            let data;
            try { data = JSON.parse(txt); } catch { data = { raw: txt }; }

            if (!res.ok) {
                throw new Error(data.detail || JSON.stringify(data));
            }
            return data;
        } catch (e) {
            if (e.message.includes('Failed to fetch')) {
                throw new Error('–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ï—Å–ª–∏ –≤—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ Render Free, –ø–æ–¥–æ–∂–¥–∏—Ç–µ 1 –º–∏–Ω—É—Ç—É, –ø–æ–∫–∞ —Å–µ—Ä–≤–µ—Ä "–ø—Ä–æ—Å–Ω–µ—Ç—Å—è".');
            }
            throw e;
        }
    }

    // === –û–°–ù–û–í–ù–û–ô –ü–†–û–¶–ï–°–° ===

    async function boot() {
        statusEl.classList.remove('hidden');
        statusEl.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É...';
        
        try {
            // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
            const me = await api('/api/me');
            
            // –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–≥—Ä—É–∑–∫–∏, –≤—Å—ë –æ–∫
            statusEl.classList.add('hidden');
            
            userInfoEl.innerHTML = `ID: ${me.tg_id}<br>${me.role === 'shop' ? '–ú–∞–≥–∞–∑–∏–Ω' : (me.role === 'courier' ? '–ö—É—Ä—å–µ—Ä' : '–ù–µ—Ç —Ä–æ–ª–∏')}`;

            if (!me.role) {
                // –†–æ–ª–∏ –Ω–µ—Ç -> –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
                regEl.classList.remove('hidden');
                appEl.classList.add('hidden');
            } else {
                // –†–æ–ª—å –µ—Å—Ç—å -> –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
                regEl.classList.add('hidden');
                appEl.classList.remove('hidden');

                if (me.role === 'shop') {
                    btnNew.classList.remove('hidden');
                } else {
                    btnNew.classList.add('hidden');
                }

                loadOrders();
            }
        } catch (e) {
            showError(e.message);
        }
    }

    // === –§–£–ù–ö–¶–ò–ò ===

    async function loadOrders() {
        ordersContainer.innerHTML = '<div style="text-align:center; padding:10px; color:#666;">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...</div>';
        try {
            const data = await api('/api/orders');
            const items = data.items || [];
            
            ordersContainer.innerHTML = ''; // –û—á–∏—Å—Ç–∏—Ç—å

            if (items.length === 0) {
                ordersContainer.innerHTML = '<div style="text-align:center; padding:20px; color:#666;">–°–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤ –ø—É—Å—Ç</div>';
                return;
            }

            // –†–µ–Ω–¥–µ—Ä –∑–∞–∫–∞–∑–æ–≤
            items.forEach(order => {
                const el = document.createElement('div');
                el.className = 'order-item';
                
                // –°—Ç–∞—Ç—É—Å —Ü–≤–µ—Ç–∞
                let statusColor = '#888';
                if (order.status === 'new') statusColor = '#00bc8c'; // –ó–µ–ª–µ–Ω—ã–π
                if (order.status === 'taken') statusColor = '#f39c12'; // –ñ–µ–ª—Ç—ã–π
                if (order.status === 'done') statusColor = '#3498db'; // –°–∏–Ω–∏–π

                el.innerHTML = `
                    <div style="display:flex; justify-content:space-between; margin-bottom: 6px;">
                        <span style="font-weight:bold; color:#fff;">–ó–∞–∫–∞–∑ #${order.id}</span>
                        <span style="color:${statusColor}; font-weight:bold; text-transform:uppercase; font-size:12px;">${order.status}</span>
                    </div>
                    <div style="font-size: 13px; color: #ccc; line-height: 1.5;">
                        <div>üìç <b>–û—Ç–∫—É–¥–∞:</b> ${order.from_address}</div>
                        <div>üèÅ <b>–ö—É–¥–∞:</b> ${order.to_address}</div>
                        ${order.price ? `<div style="margin-top:4px; color:#fff;">üí∞ <b>–¶–µ–Ω–∞:</b> ${order.price} —Å–æ–º</div>` : ''}
                        ${order.client_phone ? `<div>üìû ${order.client_phone}</div>` : ''}
                    </div>
                `;
                ordersContainer.appendChild(el);
            });

        } catch (e) {
            ordersContainer.innerHTML = `<div style="color:red; text-align:center;">–û—à–∏–±–∫–∞: ${e.message}</div>`;
        }
    }

    // === –ö–ù–û–ü–ö–ò ===

    btnRegister.onclick = async () => {
        const role = document.getElementById('role').value;
        const phone = document.getElementById('phone').value.trim();

        if (!phone) return alert('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞');

        btnRegister.disabled = true;
        btnRegister.textContent = '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è...';

        try {
            await api('/api/auth/register', { 
                method: 'POST', 
                body: JSON.stringify({ role, phone }) 
            });
            // –£—Å–ø–µ—Ö -> –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫
            location.reload();
        } catch (e) {
            alert('–û—à–∏–±–∫–∞: ' + e.message);
            btnRegister.disabled = false;
            btnRegister.textContent = '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è';
        }
    };

    btnReload.onclick = loadOrders;

    btnNew.onclick = () => {
        appEl.classList.add('hidden');
        newOrderEl.classList.remove('hidden');
    };

    btnCancel.onclick = () => {
        newOrderEl.classList.add('hidden');
        appEl.classList.remove('hidden');
    };

    btnCreate.onclick = async () => {
        const payload = {
            from_address: document.getElementById('from_address').value,
            shop_contact: document.getElementById('shop_contact').value,
            to_address: document.getElementById('to_address').value,
            to_apt: document.getElementById('to_apt').value,
            client_name: document.getElementById('client_name').value,
            client_phone: document.getElementById('client_phone').value,
            price: parseFloat(document.getElementById('price').value || '0')
        };

        if (!payload.from_address || !payload.to_address) {
            return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∞–¥—Ä–µ—Å–∞!');
        }

        btnCreate.disabled = true;
        btnCreate.textContent = '–°–æ–∑–¥–∞–Ω–∏–µ...';

        try {
            await api('/api/orders', { method: 'POST', body: JSON.stringify(payload) });
            alert('–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!');
            
            // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã
            document.querySelectorAll('#newOrder input').forEach(i => i.value = '');
            
            // –í–æ–∑–≤—Ä–∞—Ç
            newOrderEl.classList.add('hidden');
            appEl.classList.remove('hidden');
            loadOrders();
        } catch (e) {
            alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è: ' + e.message);
        } finally {
            btnCreate.disabled = false;
            btnCreate.textContent = '–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑';
        }
    };

    // –°—Ç–∞—Ä—Ç
    boot();
  </script>
</body>
</html>


